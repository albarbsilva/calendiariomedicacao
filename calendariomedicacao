#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Calend√°rio de Medica√ß√£o
Sistema completo para gerenciar medicamentos, hor√°rios e hist√≥rico
"""

import json
import os
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import time

class CalendarioMedicacao:
    def __init__(self, arquivo_dados: str = "medicamentos.json"):
        self.arquivo_dados = arquivo_dados
        self.medicamentos: List[Dict] = []
        self.historico: List[Dict] = []
        self.carregar_dados()
    
    def carregar_dados(self):
        """Carrega os dados salvos do arquivo JSON"""
        if os.path.exists(self.arquivo_dados):
            try:
                with open(self.arquivo_dados, 'r', encoding='utf-8') as f:
                    dados = json.load(f)
                    self.medicamentos = dados.get('medicamentos', [])
                    self.historico = dados.get('historico', [])
                print(f"‚úÖ Dados carregados com sucesso!")
            except Exception as e:
                print(f"‚ö†Ô∏è  Erro ao carregar dados: {e}")
                self.medicamentos = []
                self.historico = []
        else:
            print("üìù Nenhum dado anterior encontrado. Iniciando novo calend√°rio.")
    
    def salvar_dados(self):
        """Salva os dados no arquivo JSON"""
        try:
            dados = {
                'medicamentos': self.medicamentos,
                'historico': self.historico
            }
            with open(self.arquivo_dados, 'w', encoding='utf-8') as f:
                json.dump(dados, f, ensure_ascii=False, indent=2)
            print("üíæ Dados salvos com sucesso!")
        except Exception as e:
            print(f"‚ùå Erro ao salvar dados: {e}")
    
    def adicionar_medicamento(self):
        """Adiciona um novo medicamento"""
        print("\n" + "="*50)
        print("üìã ADICIONAR NOVO MEDICAMENTO")
        print("="*50)
        
        nome = input("Nome do medicamento: ").strip()
        if not nome:
            print("‚ùå Nome inv√°lido!")
            return
        
        dosagem = input("Dosagem (ex: 500mg, 1 comprimido): ").strip()
        
        print("\nHor√°rios (digite 'fim' para terminar):")
        horarios = []
        while True:
            horario = input(f"Hor√°rio {len(horarios)+1} (HH:MM): ").strip()
            if horario.lower() == 'fim':
                break
            try:
                datetime.strptime(horario, "%H:%M")
                horarios.append(horario)
            except ValueError:
                print("‚ùå Formato inv√°lido! Use HH:MM (ex: 08:30)")
        
        if not horarios:
            print("‚ùå Adicione pelo menos um hor√°rio!")
            return
        
        frequencia = input("Frequ√™ncia (ex: di√°rio, 2x/semana): ").strip()
        observacoes = input("Observa√ß√µes (opcional): ").strip()
        
        medicamento = {
            'id': len(self.medicamentos) + 1,
            'nome': nome,
            'dosagem': dosagem,
            'horarios': horarios,
            'frequencia': frequencia,
            'observacoes': observacoes,
            'ativo': True,
            'data_cadastro': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        
        self.medicamentos.append(medicamento)
        self.salvar_dados()
        print(f"\n‚úÖ Medicamento '{nome}' adicionado com sucesso!")
    
    def listar_medicamentos(self):
        """Lista todos os medicamentos cadastrados"""
        print("\n" + "="*50)
        print("üìã LISTA DE MEDICAMENTOS")
        print("="*50)
        
        if not self.medicamentos:
            print("Nenhum medicamento cadastrado.")
            return
        
        ativos = [m for m in self.medicamentos if m.get('ativo', True)]
        
        for med in ativos:
            status = "üü¢" if med.get('ativo', True) else "üî¥"
            print(f"\n{status} ID: {med['id']}")
            print(f"   Nome: {med['nome']}")
            print(f"   Dosagem: {med['dosagem']}")
            print(f"   Hor√°rios: {', '.join(med['horarios'])}")
            print(f"   Frequ√™ncia: {med['frequencia']}")
            if med.get('observacoes'):
                print(f"   Obs: {med['observacoes']}")
    
    def marcar_dose_tomada(self):
        """Marca uma dose como tomada"""
        print("\n" + "="*50)
        print("‚úÖ MARCAR DOSE TOMADA")
        print("="*50)
        
        self.listar_medicamentos()
        
        if not self.medicamentos:
            return
        
        try:
            med_id = int(input("\nID do medicamento: "))
            medicamento = next((m for m in self.medicamentos if m['id'] == med_id), None)
            
            if not medicamento:
                print("‚ùå Medicamento n√£o encontrado!")
                return
            
            print(f"\nHor√°rios dispon√≠veis para {medicamento['nome']}:")
            for i, horario in enumerate(medicamento['horarios'], 1):
                print(f"{i}. {horario}")
            
            horario_idx = int(input("\nEscolha o n√∫mero do hor√°rio: ")) - 1
            
            if 0 <= horario_idx < len(medicamento['horarios']):
                horario = medicamento['horarios'][horario_idx]
                
                registro = {
                    'medicamento_id': med_id,
                    'medicamento_nome': medicamento['nome'],
                    'dosagem': medicamento['dosagem'],
                    'horario_planejado': horario,
                    'horario_tomado': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    'data': datetime.now().strftime("%Y-%m-%d")
                }
                
                self.historico.append(registro)
                self.salvar_dados()
                print(f"\n‚úÖ Dose de {medicamento['nome']} marcada como tomada!")
            else:
                print("‚ùå Hor√°rio inv√°lido!")
                
        except ValueError:
            print("‚ùå Entrada inv√°lida!")
    
    def ver_historico(self):
        """Mostra o hist√≥rico de doses tomadas"""
        print("\n" + "="*50)
        print("üìä HIST√ìRICO DE MEDICA√á√ÉO")
        print("="*50)
        
        if not self.historico:
            print("Nenhum hist√≥rico registrado.")
            return
        
        # Filtrar por per√≠odo
        print("\n1. Hoje")
        print("2. √öltimos 7 dias")
        print("3. √öltimos 30 dias")
        print("4. Tudo")
        
        try:
            opcao = int(input("\nEscolha o per√≠odo: "))
            
            hoje = datetime.now()
            historico_filtrado = self.historico
            
            if opcao == 1:
                data_filtro = hoje.strftime("%Y-%m-%d")
                historico_filtrado = [h for h in self.historico if h['data'] == data_filtro]
            elif opcao == 2:
                data_limite = (hoje - timedelta(days=7)).strftime("%Y-%m-%d")
                historico_filtrado = [h for h in self.historico if h['data'] >= data_limite]
            elif opcao == 3:
                data_limite = (hoje - timedelta(days=30)).strftime("%Y-%m-%d")
                historico_filtrado = [h for h in self.historico if h['data'] >= data_limite]
            
            if not historico_filtrado:
                print("\nüì≠ Nenhum registro encontrado neste per√≠odo.")
                return
            
            # Agrupar por data
            por_data = {}
            for registro in historico_filtrado:
                data = registro['data']
                if data not in por_data:
                    por_data[data] = []
                por_data[data].append(registro)
            
            for data in sorted(por_data.keys(), reverse=True):
                print(f"\nüìÖ {data}")
                print("-" * 50)
                for reg in por_data[data]:
                    print(f"   ‚úÖ {reg['medicamento_nome']} ({reg['dosagem']})")
                    print(f"      Planejado: {reg['horario_planejado']} | Tomado: {reg['horario_tomado'].split()[1]}")
            
            print(f"\nüìä Total de doses: {len(historico_filtrado)}")
            
        except ValueError:
            print("‚ùå Op√ß√£o inv√°lida!")
    
    def lembretes_hoje(self):
        """Mostra os lembretes de medica√ß√£o para hoje"""
        print("\n" + "="*50)
        print("‚è∞ LEMBRETES DE HOJE")
        print("="*50)
        
        hoje = datetime.now().strftime("%Y-%m-%d")
        hora_atual = datetime.now().strftime("%H:%M")
        
        # Verificar quais doses j√° foram tomadas hoje
        doses_tomadas_hoje = [
            (h['medicamento_id'], h['horario_planejado']) 
            for h in self.historico 
            if h['data'] == hoje
        ]
        
        lembretes_pendentes = []
        lembretes_futuros = []
        
        for med in self.medicamentos:
            if not med.get('ativo', True):
                continue
                
            for horario in med['horarios']:
                if (med['id'], horario) not in doses_tomadas_hoje:
                    if horario <= hora_atual:
                        lembretes_pendentes.append((med, horario, 'pendente'))
                    else:
                        lembretes_futuros.append((med, horario, 'futuro'))
        
        if lembretes_pendentes:
            print("\nüîî PENDENTES (n√£o tomados):")
            print("-" * 50)
            for med, horario, _ in lembretes_pendentes:
                print(f"   ‚è∞ {horario} - {med['nome']} ({med['dosagem']})")
        
        if lembretes_futuros:
            print("\nüìÖ PR√ìXIMOS:")
            print("-" * 50)
            for med, horario, _ in lembretes_futuros:
                print(f"   ‚è∞ {horario} - {med['nome']} ({med['dosagem']})")
        
        if not lembretes_pendentes and not lembretes_futuros:
            print("\n‚úÖ Todas as doses de hoje foram tomadas!")
        
        # Estat√≠sticas
        total_hoje = len(lembretes_pendentes) + len(lembretes_futuros) + len([h for h in self.historico if h['data'] == hoje])
        tomadas_hoje = len([h for h in self.historico if h['data'] == hoje])
        
        if total_hoje > 0:
            print(f"\nüìä Progresso de hoje: {tomadas_hoje}/{total_hoje} doses ({int(tomadas_hoje/total_hoje*100)}%)")
    
    def remover_medicamento(self):
        """Remove ou desativa um medicamento"""
        print("\n" + "="*50)
        print("üóëÔ∏è  REMOVER MEDICAMENTO")
        print("="*50)
        
        self.listar_medicamentos()
        
        if not self.medicamentos:
            return
        
        try:
            med_id = int(input("\nID do medicamento para remover: "))
            medicamento = next((m for m in self.medicamentos if m['id'] == med_id), None)
            
            if not medicamento:
                print("‚ùå Medicamento n√£o encontrado!")
                return
            
            print(f"\nDeseja realmente remover '{medicamento['nome']}'?")
            print("1. Desativar (mant√©m hist√≥rico)")
            print("2. Remover completamente")
            print("3. Cancelar")
            
            opcao = int(input("\nEscolha: "))
            
            if opcao == 1:
                medicamento['ativo'] = False
                self.salvar_dados()
                print(f"\n‚úÖ Medicamento '{medicamento['nome']}' desativado!")
            elif opcao == 2:
                self.medicamentos.remove(medicamento)
                self.salvar_dados()
                print(f"\n‚úÖ Medicamento '{medicamento['nome']}' removido!")
            
        except ValueError:
            print("‚ùå Entrada inv√°lida!")
    
    def menu_principal(self):
        """Menu principal do sistema"""
        while True:
            print("\n" + "="*50)
            print("üíä CALEND√ÅRIO DE MEDICA√á√ÉO")
            print("="*50)
            print("1. üìã Listar medicamentos")
            print("2. ‚ûï Adicionar medicamento")
            print("3. ‚úÖ Marcar dose tomada")
            print("4. ‚è∞ Ver lembretes de hoje")
            print("5. üìä Ver hist√≥rico")
            print("6. üóëÔ∏è  Remover medicamento")
            print("7. üö™ Sair")
            print("="*50)
            
            try:
                opcao = input("\nEscolha uma op√ß√£o: ").strip()
                
                if opcao == '1':
                    self.listar_medicamentos()
                elif opcao == '2':
                    self.adicionar_medicamento()
                elif opcao == '3':
                    self.marcar_dose_tomada()
                elif opcao == '4':
                    self.lembretes_hoje()
                elif opcao == '5':
                    self.ver_historico()
                elif opcao == '6':
                    self.remover_medicamento()
                elif opcao == '7':
                    print("\nüëã At√© logo! Cuide-se bem!")
                    break
                else:
                    print("‚ùå Op√ß√£o inv√°lida!")
                
                input("\nPressione ENTER para continuar...")
                
            except KeyboardInterrupt:
                print("\n\nüëã At√© logo!")
                break
            except Exception as e:
                print(f"\n‚ùå Erro: {e}")
                input("\nPressione ENTER para continuar...")


def main():
    """Fun√ß√£o principal"""
    print("="*50)
    print("üíä BEM-VINDO AO CALEND√ÅRIO DE MEDICA√á√ÉO")
    print("="*50)
    print("Sistema para gerenciar seus medicamentos de forma f√°cil!")
    print()
    
    calendario = CalendarioMedicacao()
    calendario.menu_principal()


if __name__ == "__main__":
    main()
